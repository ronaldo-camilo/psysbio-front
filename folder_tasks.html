<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tarefas da Pasta - Sistema de Tarefas</title> <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header class="page-header">
            <div class="breadcrumb-nav" id="breadcrumbNav">&lt;Usuário&gt; &rarr; &lt;Grupo&gt; &rarr; &lt;Pasta&gt;</div>
            <a href="#" class="logout-button" id="logoutButton">Sair</a>
        </header>

        <main>
            <section class="kanban-section" id="userFolderTasksSection">
                <h2 class="kanban-section-title" id="userTasksTitle">&lt;Usuário&gt; em &lt;Pasta&gt;</h2>
                <div class="kanban-container" id="userFolderKanbanContainer">
                    <div class="kanban-column todo kanban-bg-light-pink" data-status-slug="todo">
                        <h3>To Do 📅</h3>
                        <ul class="task-list" id="userFolderTodoList"></ul>
                        <button class="add-task-button" data-task-type="user_folder" data-status-slug="todo">+ Minha tarefa aqui</button>
                    </div>
                    <div class="kanban-column inprogress kanban-bg-light-yellow" data-status-slug="inprogress">
                        <h3>In Progress ⚙️</h3>
                        <ul class="task-list" id="userFolderInprogressList"></ul>
                         <button class="add-task-button" data-task-type="user_folder" data-status-slug="inprogress">+ Minha tarefa aqui</button>
                    </div>
                    <div class="kanban-column done kanban-bg-light-green" data-status-slug="done">
                        <h3>Done ✅</h3>
                        <ul class="task-list" id="userFolderDoneList"></ul>
                        <button class="add-task-button" data-task-type="user_folder" data-status-slug="done">+ Minha tarefa aqui</button>
                    </div>
                </div>
            </section>

            <section class="kanban-section" id="generalFolderTasksSection">
                <h2 class="kanban-section-title" id="folderTasksTitle">Tarefas de &lt;Pasta&gt;</h2>
                <div class="kanban-container" id="generalFolderKanbanContainer">
                    <div class="kanban-column todo kanban-bg-light-pink" data-status-slug="todo">
                        <h3>To Do 📅</h3>
                        <ul class="task-list" id="generalFolderTodoList"></ul>
                        <button class="add-task-button" data-task-type="folder_general" data-status-slug="todo">+ Tarefa da pasta</button>
                    </div>
                    <div class="kanban-column inprogress kanban-bg-light-yellow" data-status-slug="inprogress">
                        <h3>In Progress ⚙️</h3>
                        <ul class="task-list" id="generalFolderInprogressList"></ul>
                        <button class="add-task-button" data-task-type="folder_general" data-status-slug="inprogress">+ Tarefa da pasta</button>
                    </div>
                    <div class="kanban-column done kanban-bg-light-green" data-status-slug="done">
                        <h3>Done ✅</h3>
                        <ul class="task-list" id="generalFolderDoneList"></ul>
                        <button class="add-task-button" data-task-type="folder_general" data-status-slug="done">+ Tarefa da pasta</button>
                    </div>
                </div>
            </section>

            <nav class="group-carousel">
                <h4>Outros Grupos:</h4>
                <div class="group-carousel-items" id="groupCarouselItems">
                    </div>
            </nav>
        </main>

        <footer class="footer-nav">
            <a href="#" class="return-button" id="returnToFolderListLink">&lt; Voltar</a>
        </footer>
    </div>

    <div id="taskDetailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <h3 id="modalTaskTitle">Título da Tarefa</h3>
            <p id="modalTaskDescription">Aqui vai a descrição detalhada da tarefa...</p>
            <div class="modal-info">
                <p><strong>ID:</strong> <span id="modalTaskId"></span></p>
                <p><strong>Status:</strong> <span id="modalTaskStatus"></span></p>
            </div>
            <div class="modal-actions">
                <button id="modalEditTask" class="action-button">Editar</button>
                <button id="modalClose" class="return-button">Fechar</button>
            </div>
        </div>
    </div>

    <div id="createTaskModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" id="closeCreateTaskModal">&times;</span>
            <h3>Criar Nova Tarefa</h3>
            <form id="createTaskForm">
                <div>
                    <label for="newTaskTitle">Título:</label>
                    <input type="text" id="newTaskTitle" name="title" required style="width: 95%; padding: 8px; margin-bottom:10px;">
                </div>
                <div>
                    <label for="newTaskDescription">Descrição:</label>
                    <textarea id="newTaskDescription" name="description" style="width: 95%; padding: 8px; margin-bottom:10px; min-height: 60px;"></textarea>
                </div>
                <input type="hidden" id="createTaskContext_taskType" name="taskType">
                <input type="hidden" id="createTaskContext_groupName" name="groupName">
                <input type="hidden" id="createTaskContext_folderName" name="folderName">
                <input type="hidden" id="createTaskContext_status" name="status">
                <input type="hidden" id="createTaskContext_targetListSelector" name="targetListSelector">
                <div id="createTaskError" style="color: red; margin-bottom: 10px; display: none;"></div>
                <div class="modal-actions">
                    <button type="submit" class="action-button">Criar Tarefa</button>
                    <button type="button" id="cancelCreateTaskModal" class="return-button">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let currentUser;
            try {
                currentUser = await api.getCurrentUser();
                if (!currentUser || !currentUser.isLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }
            } catch (e) {
                console.error("Error getting current user, redirecting to login.", e);
                window.location.href = 'login.html';
                return;
            }

            document.getElementById('logoutButton').addEventListener('click', async (e) => {
                e.preventDefault();
                await api.logout();
                window.location.href = 'login.html';
            });

            const urlParams = new URLSearchParams(window.location.search);
            const groupName = urlParams.get('group');
            const folderName = urlParams.get('folder');

            if (!groupName || !folderName) {
                alert("Grupo ou Pasta não especificados.");
                window.location.href = 'home.html';
                return;
            }
            const decodedGroupName = decodeURIComponent(groupName);
            const decodedFolderName = decodeURIComponent(folderName);

            document.title = `Tarefas de ${decodedFolderName} - ${decodedGroupName}`;
            document.getElementById('breadcrumbNav').textContent = `${currentUser.name || currentUser.username} → ${decodedGroupName} → ${decodedFolderName}`;
            document.getElementById('userTasksTitle').textContent = `Minhas Tarefas em ${decodedFolderName}`;
            document.getElementById('folderTasksTitle').textContent = `Tarefas Gerais da Pasta: ${decodedFolderName}`;
            document.getElementById('returnToFolderListLink').href = `folder_list.html?group=${encodeURIComponent(groupName)}`;

            // Set context for "add task" buttons in this specific folder
            document.querySelectorAll('#userFolderTasksSection .add-task-button').forEach(btn => {
                btn.dataset.groupName = groupName; // Already encoded from URL or encode it
                btn.dataset.folderName = folderName; // Already encoded from URL or encode it
            });
            document.querySelectorAll('#generalFolderTasksSection .add-task-button').forEach(btn => {
                btn.dataset.groupName = groupName;
                btn.dataset.folderName = folderName;
            });


            function renderTasksToDOM(taskTypePrefix, tasks) {
                const statuses = ['todo', 'inprogress', 'done'];
                const tasksByStatus = { todo: [], inprogress: [], done: [] };
                tasks.forEach(task => {
                    tasksByStatus[task.status] = tasksByStatus[task.status] || [];
                    tasksByStatus[task.status].push(task);
                });

                statuses.forEach(statusSlug => {
                    const listId = `${taskTypePrefix}${statusSlug.charAt(0).toUpperCase() + statusSlug.slice(1)}List`;
                    const taskListElement = document.getElementById(listId);
                    if (taskListElement) {
                        taskListElement.innerHTML = ''; // Clear list
                        (tasksByStatus[statusSlug] || []).forEach(task => {
                            const taskElement = document.createElement('li');
                            taskElement.classList.add('task-item');
                            taskElement.id = task.id;
                            taskElement.textContent = task.title;
                            taskElement.setAttribute('draggable', 'false');
                            taskElement.dataset.title = task.title;
                            taskElement.dataset.description = task.description;
                            taskListElement.appendChild(taskElement);
                        });
                    } else {
                        console.warn(`Task list element with ID ${listId} not found.`);
                    }
                });
            }

            async function loadFolderTasks() {
                try {
                    // User specific tasks in this folder
                    const userFolderTaskParams = {
                        userUsername: currentUser.username,
                        groupName: decodedGroupName,
                        folderName: decodedFolderName,
                        taskType: 'user_folder'
                    };
                    const userFolderTasks = await api.getTasks(userFolderTaskParams);
                    renderTasksToDOM('userFolder', userFolderTasks);

                    // General folder tasks
                    const generalFolderTaskParams = {
                        groupName: decodedGroupName,
                        folderName: decodedFolderName,
                        taskType: 'folder_general'
                    };
                    const generalFolderTasks = await api.getTasks(generalFolderTaskParams);
                    renderTasksToDOM('generalFolder', generalFolderTasks);

                    // Initialize Kanban for both sections after rendering all tasks
                    window.initializeKanbanEventListeners(document.getElementById('userFolderKanbanContainer'));
                    window.initializeKanbanEventListeners(document.getElementById('generalFolderKanbanContainer'));

                } catch (error) {
                    console.error("Error loading folder tasks:", error);
                }
            }
            
            const groupCarouselItemsContainer = document.getElementById('groupCarouselItems');
            if (groupCarouselItemsContainer) {
                try {
                    const groups = await api.getGroups();
                    groupCarouselItemsContainer.innerHTML = '';
                    groups.forEach(group => {
                        if (group.name !== decodedGroupName) { // Optionally filter out current group
                            const groupLink = document.createElement('a');
                            groupLink.href = `folder_list.html?group=${encodeURIComponent(group.name)}`;
                            groupLink.classList.add('group-carousel-item');
                            groupLink.textContent = group.name;
                            groupCarouselItemsContainer.appendChild(groupLink);
                        }
                    });
                } catch (error) {
                    console.error("Error loading groups for carousel:", error);
                }
            }

            await loadFolderTasks();
        });
    </script>
</body>
</html>